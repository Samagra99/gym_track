<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Workout Tracker — Cloud Synced (Final)</title>

<!-- Firebase SDKs (compat builds used for simple paste-in) -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>

<!-- ======= PASTE YOUR FIREBASE CONFIG BELOW (from Firebase Console) =======
     Replace the placeholder values with your project's config object.
     Example (do NOT leave placeholder text):
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
======================================================================== -->
<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const db = firebase.firestore();
</script>

<style>
/* -------- Responsive + Login overlay + mobile fixes -------- */
:root{
  --bg:#f7f8fb; --card:#ffffff; --accent:#2563eb; --muted:#6b7280; --ok:#10b981;
  --danger:#ef4444; --glass: rgba(0,0,0,0.04);
}
*{box-sizing:border-box}
html,body{height:100%;max-width:100%;overflow-x:hidden;}
body{
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background:var(--bg); color:#111; margin:0; padding:8px; font-size:15px; line-height:1.35;
  -webkit-text-size-adjust:100%;
}

/* Make form controls at least 16px to prevent mobile auto-zoom on focus */
input, textarea, select, button { font-size:16px; -webkit-text-size-adjust:100%; }

/* Layout */
.wrap{max-width:980px;margin:0 auto;padding:0 8px}
header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:8px 0;flex-wrap:wrap}
h1{font-size:16px;margin:0}
.controls{display:flex;gap:8px;align-items:center}
.nav-btn{padding:6px 8px;border-radius:8px;border:1px solid var(--glass);background:transparent}
.date-display{padding:6px 8px;background:#fff;border-radius:8px;box-shadow:0 1px 2px rgba(0,0,0,0.04);font-weight:600;font-size:13px}
main{display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start}
.card{background:var(--card);border-radius:10px;padding:10px;box-shadow:0 6px 14px rgba(16,24,40,0.03)}
.session{margin-bottom:8px;padding:8px;border-radius:8px;border:1px solid var(--glass)}
.session h3{margin:0 0 6px 0;font-size:15px}
.exercise-list{list-style:none;margin:0;padding:0}
.exercise-list li{display:flex;gap:8px;align-items:flex-start;padding:6px 6px;border-top:1px dashed rgba(0,0,0,0.04);font-size:14px}
.exercise-list li:first-child{border-top:0}
.exercise-list li label span{display:block;word-break:break-word;white-space:normal}
.large-btn{padding:9px 12px;border-radius:10px;font-weight:600}
.complete{background:linear-gradient(90deg,var(--ok),#0ea5a4);color:#fff}
.incomplete{background:#fff;color:var(--muted);border:1px dashed var(--glass)}
.progress{height:10px;background:linear-gradient(90deg,#e6eefc,#f3f7ff);border-radius:999px;overflow:hidden;border:1px solid var(--glass)}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7dd3fc);width:0%}
.small{font-size:12px;color:var(--muted)}

/* 30-day grid compact */
.month-grid{display:flex;gap:6px;align-items:flex-end;height:96px;padding:6px 4px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.day-col{flex:0 0 18px;text-align:center}
.bar{width:100%;border-radius:6px;background:linear-gradient(180deg,var(--accent),#60a5fa)}
.day-label{font-size:10px;color:var(--muted);margin-top:6px;white-space:nowrap}
.export-area{width:100%;height:96px;padding:8px;border-radius:8px;border:1px dashed var(--glass);background:#fafafa;font-family:monospace;font-size:13px}

/* Login overlay styles (complete) */
#loginScreen{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:20px;
  background: rgba(247,248,251,0.98); z-index:9999; -webkit-overflow-scrolling:touch;
}
.login-card{width:100%;max-width:520px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 12px 30px rgba(2,6,23,0.08);box-sizing:border-box;display:flex;flex-direction:column;gap:12px}
#loginScreen h2{margin:0;font-size:18px}
#loginScreen .muted{color:var(--muted);font-size:14px}
#googleLoginBtn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 14px;font-size:15px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent),#60a5fa);color:#fff;cursor:pointer;box-shadow:0 6px 14px rgba(37,99,235,0.12)}
#loginCloseBtn{align-self:flex-end;background:transparent;border:0;color:var(--muted);font-size:14px;padding:6px;cursor:pointer}
#loginScreen button:focus{outline:3px solid rgba(37,99,235,0.12);outline-offset:3px}

/* Mobile adjustments (compact) */
@media (max-width:900px){
  body{padding:6px}
  main{grid-template-columns:1fr;gap:8px}
  .card{padding:8px}
  .month-grid{height:84px;gap:4px}
  .day-col{flex:0 0 24px}
  .exercise-list li{padding:8px 6px;font-size:15px}
  .large-btn{width:100%;padding:10px}
  .session-actions{display:flex;flex-direction:column;gap:8px}
  .date-display{font-size:13px;padding:6px 8px}
  .login-card{padding:14px}
}

/* Very small screens */
@media (max-width:380px){
  html,body{font-size:14px}
  .day-col{flex:0 0 28px}
  .month-grid{height:74px}
  .export-area{height:80px;font-size:12px}
}

/* Safety: ensure nothing forces horizontal overflow */
*{max-width:100vw;box-sizing:border-box}

/* Focus outlines */
button:focus, input:focus, textarea:focus { outline:3px solid rgba(37,99,235,0.12); outline-offset:2px; }
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginScreen" aria-hidden="false">
  <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <button id="loginCloseBtn" title="Close (test only)">✕</button>
    <h2 id="loginTitle">Sign in to sync your workout data</h2>
    <div class="muted">Your progress will be stored securely in your Firebase Firestore account and backed up locally.</div>
    <button id="googleLoginBtn" aria-label="Sign in with Google">Sign in with Google</button>
  </div>
</div>

<!-- APP UI (hidden until signed-in) -->
<div class="wrap" id="appUI" style="display:none;">
  <header>
    <div>
      <h1>Workout Tracker — Cloud Synced</h1>
      <div class="small muted">Auto-sync to Firestore • Offline-safe</div>
    </div>
    <div class="controls">
      <div style="display:flex;gap:6px;align-items:center">
        <button class="nav-btn" id="prevBtn" aria-label="Previous day">&larr;</button>
        <button class="nav-btn" id="todayBtn">Today</button>
        <button class="nav-btn" id="nextBtn" aria-label="Next day">&rarr;</button>
      </div>
      <div class="date-display" id="dateDisplay">—</div>
    </div>
  </header>

  <main>
    <section>
      <div class="card" id="dayCard">
        <h2 id="dayTitle">Workout</h2>

        <div class="session" id="morningSession">
          <h3>Morning Session (AM)</h3>
          <ul class="exercise-list" id="morningList"></ul>
          <div class="session-actions">
            <button id="toggleMorning" class="large-btn incomplete">Mark Morning Complete</button>
            <div class="small muted" id="morningStatus">Not completed</div>
          </div>
        </div>

        <div class="session" id="eveningSession">
          <h3>Evening Session (PM)</h3>
          <ul class="exercise-list" id="eveningList"></ul>
          <div class="session-actions">
            <button id="toggleEvening" class="large-btn incomplete">Mark Evening Complete</button>
            <div class="small muted" id="eveningStatus">Not completed</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="small muted">Daily Progress</div>
          <div class="progress" title="Daily progress"><i id="dailyProgressBar" style="width:0%"></i></div>
          <div class="meta" style="margin-top:8px">
            <strong id="dailyPercent">0%</strong>
            <div class="small muted" id="daySummary">0 of 0 exercises complete</div>
          </div>

          <div style="margin-top:10px" class="action-row">
            <button id="resetDay" class="pill">Reset Day</button>
            <button id="exportBtn" class="pill">Export JSON</button>
            <button id="importBtn" class="pill">Import JSON</button>
            <button id="clearAll" class="pill danger">Clear ALL Cloud Data</button>
          </div>
        </div>
      </div>
    </section>

    <aside>
      <div class="card">
        <h3>30-Day Progress</h3>
        <div class="small muted">Click a bar to open that day.</div>
        <div class="month-grid" id="monthGrid"></div>

        <div style="margin-top:12px">
          <div class="small muted">Overall</div>
          <div class="progress" style="margin-top:6px"><i id="overallBar" style="width:0%"></i></div>
          <div class="meta" style="margin-top:8px">
            <strong id="overallPercent">0%</strong>
            <div class="small muted" id="overallSummary">0 of 0 exercises complete</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small muted">Export / Import</div>
          <textarea id="exportArea" class="export-area" placeholder="Exported JSON will appear here"></textarea>
        </div>
      </div>
    </aside>
  </main>

  <footer style="margin-top:12px;text-align:center;color:var(--muted);font-size:13px">
    Tip: For first-time setup add your domain to Firebase Authorized Domains (or use localhost/ngrok for testing).
  </footer>
</div>

<script>
/* ======= Defensive startup: blur any focused element to avoid auto-zoom ====== */
window.addEventListener('load', () => {
  try{ if(document.activeElement) document.activeElement.blur(); }catch(e){}
  setTimeout(()=>{ try{ window.scrollTo(0,0);}catch(e){} }, 50);
});

/* ============================
   App: Firebase auth + Firestore sync
   Data model stored as:
   data = {
     "YYYY-MM-DD": {
       morning: { exercises: [bool,...] },
       evening: { exercises: [bool,...] }
     },
     ...
   }
   Stored in Firestore at: users/{uid}/workout/data
   Also kept in localStorage as backup (STORAGE_KEY)
   ============================ */

const STORAGE_KEY = "twicedaily_workout_cloud_v1";
let data = {};
let userId = null;
let currentDate = new Date();

// Plan definition
const PLAN = {
  morning: [
    "Warm-up: 5 min brisk walk or light jog + dynamic stretches",
    "Jumping Jacks: 3 sets x 40 seconds (or 30 reps)",
    "Bodyweight Squats: 3 sets x 12-15 reps",
    "Plank: 3 sets x 30-45 seconds",
    "Standing Calf Raises: 3 sets x 20 reps",
    "Cool down: 3-5 minutes stretching"
  ],
  evening: [
    "Warm-up: 3-5 min light cardio + mobility",
    "Push-ups: 3 sets x 8-15 reps (modify on knees if needed)",
    "Glute Bridge: 3 sets x 12-15 reps",
    "Walking Lunges: 3 sets x 10-12 steps per leg",
    "Leg Raises (lying): 3 sets x 10-15 reps",
    "Optional finisher: 5-8 minutes steady cardio or core AMRAP",
    "Cool down: 3-5 minutes stretching"
  ]
};

// DOM refs
const loginScreen = document.getElementById('loginScreen');
const loginCloseBtn = document.getElementById('loginCloseBtn');
const googleLoginBtn = document.getElementById('googleLoginBtn');
const appUI = document.getElementById('appUI');

const morningList = document.getElementById('morningList');
const eveningList = document.getElementById('eveningList');
const toggleMorning = document.getElementById('toggleMorning');
const toggleEvening = document.getElementById('toggleEvening');
const morningStatus = document.getElementById('morningStatus');
const eveningStatus = document.getElementById('eveningStatus');
const dailyProgressBar = document.getElementById('dailyProgressBar');
const dailyPercent = document.getElementById('dailyPercent');
const daySummary = document.getElementById('daySummary');
const monthGrid = document.getElementById('monthGrid');
const overallBar = document.getElementById('overallBar');
const overallPercent = document.getElementById('overallPercent');
const overallSummary = document.getElementById('overallSummary');
const dateDisplay = document.getElementById('dateDisplay');
const dayTitle = document.getElementById('dayTitle');
const exportArea = document.getElementById('exportArea');

// ---------- Utility functions ----------
const toISO = d => d.toISOString().slice(0,10);
function parseISO(s){ return new Date(s + "T00:00:00"); }
function formatFriendly(d){ return d.toLocaleDateString(undefined, { weekday:"short", day:"numeric", month:"short" }); }

// Local backup load/save
function loadLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) data = JSON.parse(raw);
  }catch(e){ console.warn("loadLocal failed", e); data = {}; }
}
function saveLocal(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){ console.warn("saveLocal failed", e); } }

// Firestore helpers
async function loadFromFirestore(){
  if(!userId) return;
  try{
    const docRef = db.collection('users').doc(userId).collection('workout').doc('data');
    const snap = await docRef.get();
    if(snap.exists){
      data = snap.data();
      saveLocal();
    } else {
      // if Firestore empty but local backup exists, push local to cloud
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        data = JSON.parse(raw);
        await saveToFirestore();
      } else data = {};
    }
  }catch(e){
    console.warn("loadFromFirestore failed", e);
    // keep local if present
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) data = JSON.parse(raw);
  }
  updateDayUI();
}
async function saveToFirestore(){
  if(!userId){ saveLocal(); return; }
  try{
    const docRef = db.collection('users').doc(userId).collection('workout').doc('data');
    await docRef.set(data, { merge: true });
    saveLocal();
  }catch(e){ console.warn("saveToFirestore failed", e); saveLocal(); }
}

// Ensure day exists and normalize lengths if plan changes
function ensureDay(iso){
  if(!data[iso]) {
    data[iso] = {
      morning: { exercises: Array(PLAN.morning.length).fill(false) },
      evening: { exercises: Array(PLAN.evening.length).fill(false) }
    };
  } else {
    if(!Array.isArray(data[iso].morning?.exercises) || data[iso].morning.exercises.length !== PLAN.morning.length)
      data[iso].morning = { exercises: Array(PLAN.morning.length).fill(false) };
    if(!Array.isArray(data[iso].evening?.exercises) || data[iso].evening.exercises.length !== PLAN.evening.length)
      data[iso].evening = { exercises: Array(PLAN.evening.length).fill(false) };
  }
}
function getDayState(iso){ ensureDay(iso); return data[iso]; }
function sessionCompleted(s){ return s.exercises.every(Boolean); }

// --------- Rendering ----------
function renderExerciseList(listEl, items, sessionName){
  listEl.innerHTML = '';
  const iso = toISO(currentDate);
  ensureDay(iso);
  const state = data[iso][sessionName];
  items.forEach((txt, idx)=>{
    const li = document.createElement('li');
    li.innerHTML = `
      <label>
        <input type="checkbox" data-session="${sessionName}" data-idx="${idx}" ${state.exercises[idx] ? 'checked' : ''}>
        <span>${txt}</span>
      </label>
    `;
    listEl.appendChild(li);
  });
  listEl.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const sess = e.target.dataset.session;
      const i = Number(e.target.dataset.idx);
      const iso2 = toISO(currentDate);
      ensureDay(iso2);
      data[iso2][sess].exercises[i] = e.target.checked;
      saveToFirestore();
      updateDayUI();
    });
  });
}

function updateDayUI(){
  const iso = toISO(currentDate);
  dateDisplay.textContent = currentDate.toDateString();
  dayTitle.textContent = "Workout for " + currentDate.toDateString();

  renderExerciseList(morningList, PLAN.morning, 'morning');
  renderExerciseList(eveningList, PLAN.evening, 'evening');

  const st = getDayState(iso);
  const mDone = st.morning.exercises.filter(Boolean).length;
  const eDone = st.evening.exercises.filter(Boolean).length;
  morningStatus.textContent = `${mDone}/${PLAN.morning.length}`;
  eveningStatus.textContent = `${eDone}/${PLAN.evening.length}`;

  const mComplete = sessionCompleted(st.morning);
  const eComplete = sessionCompleted(st.evening);
  toggleMorning.textContent = mComplete ? "Morning Completed ✓" : "Mark Morning Complete";
  toggleMorning.className = "large-btn " + (mComplete ? "complete" : "incomplete");
  toggleEvening.textContent = eComplete ? "Evening Completed ✓" : "Mark Evening Complete";
  toggleEvening.className = "large-btn " + (eComplete ? "complete" : "incomplete");

  const total = PLAN.morning.length + PLAN.evening.length;
  const done = mDone + eDone;
  const pct = total === 0 ? 0 : Math.round((done / total) * 100);
  dailyProgressBar.style.width = pct + '%';
  dailyPercent.textContent = pct + '%';
  daySummary.textContent = `${done} of ${total} exercises complete`;

  renderMonth();
  renderOverall();
}

// 30-day grid
function renderMonth(){
  monthGrid.innerHTML = '';
  for(let i=29;i>=0;i--){
    const d = new Date(currentDate);
    d.setDate(d.getDate() - i);
    const iso = toISO(d);
    let done = 0;
    const total = PLAN.morning.length + PLAN.evening.length;
    if(data[iso]){
      done = data[iso].morning.exercises.filter(Boolean).length + data[iso].evening.exercises.filter(Boolean).length;
    }
    const pct = total === 0 ? 0 : Math.round(done / total * 100);
    const col = document.createElement('div');
    col.className = 'day-col';
    col.title = `${d.toDateString()} — ${pct}% (${done}/${total})`;
    col.innerHTML = `<div style="height:84px;display:flex;align-items:flex-end;"><div class="bar" style="height:${pct}%"></div></div><div class="day-label">${d.getDate()}</div>`;
    col.addEventListener('click', ()=>{ currentDate = new Date(d); updateDayUI(); });
    monthGrid.appendChild(col);
  }
}

// overall
function renderOverall(){
  let done = 0, planned = 0;
  Object.keys(data).forEach(k=>{
    const s = data[k];
    done += s.morning.exercises.filter(Boolean).length + s.evening.exercises.filter(Boolean).length;
    planned += PLAN.morning.length + PLAN.evening.length;
  });
  const pct = planned === 0 ? 0 : Math.round(done / planned * 100);
  overallBar.style.width = pct + '%';
  overallPercent.textContent = pct + '%';
  overallSummary.textContent = `${done} of ${planned} exercises complete`;
}

// ---------- Actions ----------
document.getElementById('prevBtn').addEventListener('click', ()=>{ currentDate.setDate(currentDate.getDate()-1); updateDayUI(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ currentDate.setDate(currentDate.getDate()+1); updateDayUI(); });
document.getElementById('todayBtn').addEventListener('click', ()=>{ currentDate = new Date(); updateDayUI(); });

toggleMorning.addEventListener('click', ()=>{
  const iso = toISO(currentDate);
  ensureDay(iso);
  const st = data[iso].morning;
  const all = sessionCompleted(st);
  st.exercises = st.exercises.map(()=> !all);
  saveToFirestore();
  updateDayUI();
});
toggleEvening.addEventListener('click', ()=>{
  const iso = toISO(currentDate);
  ensureDay(iso);
  const st = data[iso].evening;
  const all = sessionCompleted(st);
  st.exercises = st.exercises.map(()=> !all);
  saveToFirestore();
  updateDayUI();
});

document.getElementById('resetDay').addEventListener('click', ()=>{
  const iso = toISO(currentDate);
  if(data[iso]) { delete data[iso]; saveToFirestore(); }
  updateDayUI();
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  exportArea.value = JSON.stringify(data, null, 2);
  alert('Export JSON placed in the text box below.');
});
document.getElementById('importBtn').addEventListener('click', async ()=>{
  try{
    const parsed = JSON.parse(exportArea.value);
    // basic validation
    const ok = Object.keys(parsed).every(k=>/^\d{4}-\d{2}-\d{2}$/.test(k));
    if(!ok) throw new Error('Invalid format');
    data = parsed;
    await saveToFirestore();
    updateDayUI();
    alert('Import successful');
  }catch(e){
    alert('Import failed: ' + (e.message || e));
  }
});
document.getElementById('clearAll').addEventListener('click', async ()=>{
  if(!confirm('Delete ALL workout data from the cloud?')) return;
  data = {};
  await saveToFirestore();
  updateDayUI();
});

// optional test-close for overlay (for local dev only; remove in production)
loginCloseBtn?.addEventListener('click', ()=>{
  loginScreen.classList.add('hidden');
  appUI.style.display = 'block';
  userId = 'local-test-user';
  loadLocal();
  updateDayUI();
});

// ---------- Firebase auth logic ----------
googleLoginBtn.addEventListener('click', async ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  try{
    // try popup first
    await auth.signInWithPopup(provider);
  }catch(err){
    console.warn('Popup failed, falling back to redirect:', err && err.code);
    try{ await auth.signInWithRedirect(provider); }catch(e){ console.error('Redirect failed', e); alert('Sign-in failed; see console.'); }
  }
});

auth.onAuthStateChanged(async (user)=>{
  if(user){
    userId = user.uid;
    loginScreen.classList.add('hidden');
    appUI.style.display = 'block';
    await loadFromFirestore();
  } else {
    // show login overlay
    loginScreen.classList.remove('hidden');
    appUI.style.display = 'none';
  }
});

// ---------- Initialize: load local backup and UI ----------
loadLocal();
updateDayUI();

</script>
</body>
</html>
